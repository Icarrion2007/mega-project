// scripts/fetch-money-trail.js - PRODUCTION v2.0 (Contributions)
require('dotenv').config({ path: '.env.development' });
const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
const fs = require('fs').promises;
const path = require('path');

const API_KEY = process.env.FEC_API_KEY;
const BASE_URL = 'https://api.open.fec.gov/v1';

async function fetchContributions() {
  console.log('üí∞ M.E.G.A.: Fetching campaign contributions from FEC...');
  
  const endpoint = `${BASE_URL}/schedules/schedule_a/`;
  // Parameters for meaningful, recent individual contributions
  const params = new URLSearchParams({
    api_key: API_KEY,
    per_page: '25', // Increased for a richer view
    sort: '-contribution_receipt_amount', // Show largest contributions first
    two_year_transaction_period: '2024',
    is_individual: 'true', // Filter for individual donors
    min_amount: '200', // Focus on more significant amounts
  });

  try {
    const response = await fetch(`${endpoint}?${params.toString()}`);
    
    if (!response.ok) {
      throw new Error(`FEC API error: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Format the data for our Triangulation Engine
    const formattedData = {
      fetched_at: new Date().toISOString(),
      source: 'Federal Election Commission (FEC)',
      endpoint: '/schedules/schedule_a/',
      note: 'Individual campaign contributions (>= $200), sorted by amount.',
      results: data.results.map(item => ({
        contributor: item.contributor_name,
        amount: item.contribution_receipt_amount,
        date: item.contribution_receipt_date || 'Date not reported',
        recipient: item.committee?.name || 'N/A',
        state: item.contributor_state,
        zip_code: item.contributor_zip,
        employer: item.contributor_employer,
        occupation: item.contributor_occupation
      }))
    };
    
    // Ensure the data directory exists
    const outputPath = path.join(__dirname, '..', 'src', 'data', 'moneyTrail.json');
    await fs.mkdir(path.dirname(outputPath), { recursive: true });
    
    // Write the formatted data
    await fs.writeFile(outputPath, JSON.stringify(formattedData, null, 2));
    console.log(`‚úÖ Success! Saved ${formattedData.results.length} contributions to ${outputPath}`);
    console.log(`   Sample: ${formattedData.results[0]?.contributor} - $${formattedData.results[0]?.amount} to ${formattedData.results[0]?.recipient}`);
    
    return true;
    
  } catch (error) {
    console.error('‚ùå Failed to fetch contribution data:', error.message);
    console.log('‚ö†Ô∏è  Falling back to candidate data...');
    return await fetchCandidatesFallback(); // Call fallback function
  }
}

// FALLBACK FUNCTION: Original candidate data (if contributions fail)
async function fetchCandidatesFallback() {
  console.log('üîÑ FEC contributions unavailable. Falling back to candidate list...');
  
  const endpoint = `${BASE_URL}/candidates/`;
  const params = new URLSearchParams({
    api_key: API_KEY,
    per_page: '10',
    sort: 'name',
    office: 'P'
  });

  try {
    const response = await fetch(`${endpoint}?${params.toString()}`);
    const data = await response.json();
    
    const fallbackData = {
      fetched_at: new Date().toISOString(),
      source: 'FEC Fallback Data - Contributions Unavailable',
      note: 'This is candidate data. The contributions API may be temporarily down.',
      results: data.results.map(candidate => ({
        contributor: candidate.name,
        amount: null,
        date: null,
        recipient: `Candidate for ${candidate.office_full}`,
        state: candidate.state,
        zip_code: null,
        employer: null,
        occupation: null
      }))
    };
    
    const outputPath = path.join(__dirname, '..', 'src', 'data', 'moneyTrail.json');
    await fs.writeFile(outputPath, JSON.stringify(fallbackData, null, 2));
    console.log(`‚ö†Ô∏è  Fallback data saved with ${fallbackData.results.length} candidates.`);
    return true;
    
  } catch (fallbackError) {
    console.error('üí• Critical: Both FEC endpoints failed.', fallbackError.message);
    // Ultimate fallback: write a static error file
    const errorData = {
      fetched_at: new Date().toISOString(),
      source: 'M.E.G.A. Project - Data Unavailable',
      note: 'FEC API is unreachable. Please check network connection and API key.',
      results: []
    };
    const outputPath = path.join(__dirname, '..', 'src', 'data', 'moneyTrail.json');
    await fs.writeFile(outputPath, JSON.stringify(errorData, null, 2));
    console.log('üìù Wrote error placeholder to prevent build failure.');
    return false;
  }
}

// Execute
fetchContributions();