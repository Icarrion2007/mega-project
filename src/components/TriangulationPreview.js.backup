import React, { useState } from 'react';
import { useStaticQuery, graphql } from 'gatsby';
import styled from 'styled-components';

const Container = styled.div`
  padding: 2rem;
  background: #0A1D3F;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 229, 255, 0.2);
  margin: 2rem 0;
  color: #ffffff;
  border: 1px solid rgba(0, 229, 255, 0.3);
`;

const Header = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid rgba(0, 229, 255, 0.5);
`;

const Title = styled.h2`
  color: #00E5FF;
  margin: 0;
  font-size: 1.8rem;
  font-weight: 700;
`;

const AnalysisSection = styled.div`
  margin: 2rem 0;
  padding: 1.5rem;
  background: rgba(0, 229, 255, 0.1);
  border-radius: 8px;
  border-left: 4px solid #00E5FF;
  color: #ffffff;
`;

const SectionTitle = styled.h3`
  color: #00E5FF;
  margin-top: 0;
  margin-bottom: 1rem;
  font-weight: 600;
`;

const DataTable = styled.table`
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
  font-size: 0.95rem;
  color: #ffffff;

  th {
    background: rgba(0, 229, 255, 0.2);
    color: #00E5FF;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    border: 1px solid rgba(0, 229, 255, 0.3);
  }

  td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    vertical-align: middle;
    color: #ffffff;
  }

  tr:hover {
    background: rgba(0, 229, 255, 0.05);
  }

  tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.03);
  }
`;

const Pagination = styled.div`
  display: flex;
  justify-content: center;
  margin-top: 2rem;
  gap: 0.5rem;

  .pagination-button {
    padding: 8px 16px;
    border: 1px solid rgba(0, 229, 255, 0.5);
    background: rgba(0, 229, 255, 0.1);
    cursor: pointer;
    border-radius: 4px;
    color: #ffffff;
    font-weight: 500;

    &:hover {
      background: rgba(0, 229, 255, 0.2);
      border-color: #00E5FF;
    }

    &:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    &.active {
      background: #00E5FF;
      color: #0A1D3F;
      border-color: #00E5FF;
    }
  }
`;

const ColumnContainer = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 2rem;
  margin-top: 2rem;

  @media (max-width: 1200px) {
    grid-template-columns: 1fr;
  }
`;

const Column = styled.div`
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  min-height: 500px;
  border: 1px solid rgba(0, 229, 255, 0.2);
  display: flex;
  flex-direction: column;
`;

const ColumnTitle = styled.h3`
  color: #00E5FF;
  margin-top: 0;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #00E5FF;
  font-size: 1.2rem;
`;

const ScoreBar = styled.div`
  width: 100%;
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  margin-top: 4px;
  overflow: hidden;

  .score-fill {
    height: 100%;
    background: ${props => 
      props.score > 0.7 ? '#4caf50' : 
      props.score > 0.4 ? '#ff9800' : '#f44336'
    };
    width: ${props => `${props.score * 100}%`};
    border-radius: 3px;
    transition: width 0.3s ease;
  }
`;

const TriangulationPreview = () => {
  const [currentPage, setCurrentPage] = useState(1);
  const recordsPerPage = 15;

  const data = useStaticQuery(graphql`
    query MoneyTrailQueryV42 {
      allMoneyTrail(sort: {contribution_receipt_amount: DESC}) {
        nodes {
          id
          contributor_name
          contribution_receipt_amount
          contribution_receipt_date
          contributor_employer
          contributor_occupation
          contributor_city
          contributor_state
          committee_name
          committee_type_full
          committee_id
          treasurer_name
          party_full
          state_full
          influence_score
          transparency_score
          longevity_score
          accountability_score
          report_year
          two_year_transaction_period
        }
      }
      metadata: moneyTrailMetadata {
        total_amount
        total_contributions
        parties_present
        parties_full_present
        enhanced
        timestamp
      }
    }
  `);

  const contributions = data.allMoneyTrail?.nodes || [];
  const metadata = data.metadata || {};
  
  // Sort by influence score if available
  const sortedContributions = [...contributions].sort((a, b) => 
    (b.influence_score || 0) - (a.influence_score || 0)
  );
  
  const totalPages = Math.ceil(sortedContributions.length / recordsPerPage);
  const startIndex = (currentPage - 1) * recordsPerPage;
  const endIndex = startIndex + recordsPerPage;
  const currentRecords = sortedContributions.slice(startIndex, endIndex);

  // Format date for display
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      });
    } catch (e) {
      return dateString;
    }
  };

  // Format currency
  const formatCurrency = (amount) => {
    if (!amount) return '$0';
    if (amount >= 1000000) {
      return `$${(amount / 1000000).toFixed(1)}M`;
    }
    if (amount >= 1000) {
      return `$${(amount / 1000).toFixed(1)}K`;
    }
    return `$${amount.toFixed(0)}`;
  };

  return (
    <Container>
      <Header>
        <Title>M.E.G.A. Triangulation Engine V4.2</Title>
        <div style={{ color: '#cccccc', fontSize: '0.9rem' }}>
          <strong>STATUS: OPERATIONAL</strong> ‚Ä¢ 
          Records: {metadata.total_contributions || contributions.length} ‚Ä¢ 
          Updated: {metadata.timestamp ? formatDate(metadata.timestamp) : 'Today'}
        </div>
      </Header>
      
      <AnalysisSection>
        <SectionTitle>üéØ M.E.G.A. V4.2 Enhanced Analysis</SectionTitle>
        <p style={{ color: '#ffffff', marginBottom: '0.5rem' }}>
          <strong>Multi-Factor Scoring Active:</strong> Influence, Transparency, Longevity, and Accountability metrics calculated in real-time.
        </p>
        <p style={{ color: '#ffffff', marginBottom: '0.5rem' }}>
          <strong>Total Tracked:</strong> {formatCurrency(metadata.total_amount)} across {metadata.total_contributions || contributions.length} contributions.
        </p>
        <p style={{ color: '#ffffff' }}>
          <strong>Parties Tracked:</strong> {metadata.parties_present?.join(', ') || 'Multiple'}
          {metadata.enhanced && <span style={{ color: '#ffc107', marginLeft: '1rem' }}>‚Ä¢ V4.2 ENHANCED</span>}
        </p>
      </AnalysisSection>
      
      <ColumnContainer>
        {/* Column 1: Power/Money Trail - NOW WITH DATA */}
        <Column>
          <ColumnTitle>
            üí∞ Power/Money Trail
            <div style={{ fontSize: '0.8rem', color: '#cccccc', marginTop: '0.25rem' }}>
              FEC API ‚Ä¢ {contributions.length} records
            </div>
          </ColumnTitle>
          
          <DataTable>
            <thead>
              <tr>
                <th>Donor/Committee</th>
                <th>Amount</th>
                <th>Influence</th>
              </tr>
            </thead>
            <tbody>
              {currentRecords.map((item) => (
                <tr key={item.id}>
                  <td>
                    <div style={{ fontWeight: '600' }}>
                      {item.contributor_name || item.committee_name || 'Unknown'}
                    </div>
                    {item.contributor_employer && (
                      <div style={{ fontSize: '0.8rem', color: '#cccccc' }}>
                        {item.contributor_employer}
                        {item.contributor_occupation && ` ‚Ä¢ ${item.contributor_occupation}`}
                      </div>
                    )}
                    {item.committee_type_full && (
                      <div style={{ fontSize: '0.75rem', color: '#888' }}>
                        {item.committee_type_full}
                      </div>
                    )}
                  </td>
                  <td>
                    <div style={{ fontWeight: '700', color: '#00E5FF' }}>
                      {formatCurrency(item.contribution_receipt_amount)}
                    </div>
                    <div style={{ fontSize: '0.8rem', color: '#cccccc' }}>
                      {formatDate(item.contribution_receipt_date)}
                      {item.contributor_state && ` ‚Ä¢ ${item.contributor_state}`}
                    </div>
                  </td>
                  <td>
                    <ScoreBar score={item.influence_score || 0}>
                      <div className="score-fill" />
                    </ScoreBar>
                    <div style={{ 
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      fontSize: '0.8rem',
                      marginTop: '2px'
                    }}>
                      <span style={{ color: '#cccccc' }}>Influence</span>
                      <span style={{ color: '#ffffff', fontWeight: '600' }}>
                        {((item.influence_score || 0) * 100).toFixed(0)}%
                      </span>
                    </div>
                    
                    {/* Additional scores in compact view */}
                    <div style={{ 
                      display: 'grid', 
                      gridTemplateColumns: '1fr 1fr',
                      gap: '4px',
                      marginTop: '8px',
                      fontSize: '0.7rem'
                    }}>
                      <div>
                        <div style={{ color: '#888' }}>Transparency</div>
                        <div style={{ color: '#4caf50' }}>
                          {((item.transparency_score || 0) * 100).toFixed(0)}%
                        </div>
                      </div>
                      <div>
                        <div style={{ color: '#888' }}>Accountability</div>
                        <div style={{ color: '#ff9800' }}>
                          {((item.accountability_score || 0) * 100).toFixed(0)}%
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </DataTable>
          
          {totalPages > 1 && (
            <Pagination>
              <button
                className="pagination-button"
                onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                disabled={currentPage === 1}
              >
                Previous
              </button>
              {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                const pageNum = i + 1;
                return (
                  <button
                    key={pageNum}
                    className={`pagination-button ${currentPage === pageNum ? 'active' : ''}`}
                    onClick={() => setCurrentPage(pageNum)}
                  >
                    {pageNum}
                  </button>
                );
              })}
              {totalPages > 5 && (
                <>
                  <span style={{ color: '#cccccc', padding: '8px' }}>...</span>
                  <button
                    className="pagination-button"
                    onClick={() => setCurrentPage(totalPages)}
                  >
                    {totalPages}
                  </button>
                </>
              )}
              <button
                className="pagination-button"
                onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                disabled={currentPage === totalPages}
              >
                Next
              </button>
            </Pagination>
          )}
        </Column>
        
        {/* Column 2: Official Narrative - WITH CONTENT */}
        <Column>
          <ColumnTitle>
            üìú Official Narrative
            <div style={{ fontSize: '0.8rem', color: '#cccccc', marginTop: '0.25rem' }}>
              Legislative Tracking ‚Ä¢ Phase 3.2
            </div>
          </ColumnTitle>
          
          <div style={{ 
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            alignItems: 'center',
            textAlign: 'center',
            padding: '2rem'
          }}>
            <div style={{ 
              fontSize: '3rem',
              marginBottom: '1rem',
              color: '#00E5FF',
              opacity: 0.7
            }}>
              ‚öñÔ∏è
            </div>
            
            <h4 style={{ 
              color: '#00E5FF', 
              marginBottom: '1rem',
              fontSize: '1.3rem'
            }}>
              Congress.gov API Integration
            </h4>
            
            <div style={{ 
              color: '#cccccc', 
              lineHeight: '1.6',
              maxWidth: '400px',
              marginBottom: '2rem'
            }}>
              <p>
                <strong>Next Masterpiece Layer:</strong> Connecting campaign contributions to legislative actions.
              </p>
              <p style={{ fontSize: '0.9rem', marginTop: '1rem' }}>
                This column will display bills sponsored, voting records, and committee assignments linked to each donor/committee.
              </p>
            </div>
            
            <div style={{
              background: 'rgba(0, 229, 255, 0.1)',
              padding: '1rem',
              borderRadius: '8px',
              border: '1px solid rgba(0, 229, 255, 0.3)',
              width: '100%',
              marginTop: '1rem'
            }}>
              <div style={{ 
                color: '#00E5FF',
                fontSize: '0.9rem',
                fontWeight: '600',
                marginBottom: '0.5rem'
              }}>
                üîß DEVELOPMENT STATUS
              </div>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
                fontSize: '0.85rem',
                color: '#cccccc'
              }}>
                <div style={{
                  width: '10px',
                  height: '10px',
                  borderRadius: '50%',
                  background: '#ff9800',
                  animation: 'pulse 2s infinite'
                }} />
                <span>API Research in Progress</span>
              </div>
              <div style={{ 
                marginTop: '0.5rem',
                fontSize: '0.8rem',
                color: '#888'
              }}>
                Target: Q1 2024 ‚Ä¢ Schema: LegislativeAction
              </div>
            </div>
          </div>
        </Column>
        
        {/* Column 3: Ground Truth - WITH CONTENT */}
        <Column>
          <ColumnTitle>
            üìä Ground Truth
            <div style={{ fontSize: '0.8rem', color: '#cccccc', marginTop: '0.25rem' }}>
              Outcome Metrics ‚Ä¢ Phase 3.3
            </div>
          </ColumnTitle>
          
          <div style={{ 
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'center',
            alignItems: 'center',
            textAlign: 'center',
            padding: '2rem'
          }}>
            <div style={{ 
              fontSize: '3rem',
              marginBottom: '1rem',
              color: '#00E5FF',
              opacity: 0.7
            }}>
              üìà
            </div>
            
            <h4 style={{ 
              color: '#00E5FF', 
              marginBottom: '1rem',
              fontSize: '1.3rem'
            }}>
              Impact & Outcome Analysis
            </h4>
            
            <div style={{ 
              color: '#cccccc', 
              lineHeight: '1.6',
              maxWidth: '400px',
              marginBottom: '2rem'
            }}>
              <p>
                <strong>Final Triangulation Layer:</strong> Measuring real-world impact of political contributions.
              </p>
              <p style={{ fontSize: '0.9rem', marginTop: '1rem' }}>
                Planned data sources: World Bank API, Government outcome metrics, policy implementation tracking.
              </p>
            </div>
            
            <div style={{
              background: 'rgba(0, 229, 255, 0.1)',
              padding: '1rem',
              borderRadius: '8px',
              border: '1px solid rgba(0, 229, 255, 0.3)',
              width: '100%'
            }}>
              <div style={{ 
                color: '#00E5FF',
                fontSize: '0.9rem',
                fontWeight: '600',
                marginBottom: '0.5rem'
              }}>
                üìã PLANNED METRICS
              </div>
              <div style={{
                display: 'grid',
                gridTemplateColumns: '1fr 1fr',
                gap: '0.75rem',
                fontSize: '0.85rem'
              }}>
                <div style={{ color: '#cccccc', textAlign: 'left' }}>
                  ‚Ä¢ Policy Outcomes
                </div>
                <div style={{ color: '#888', textAlign: 'right' }}>
                  World Bank
                </div>
                <div style={{ color: '#cccccc', textAlign: 'left' }}>
                  ‚Ä¢ Economic Impact
                </div>
                <div style={{ color: '#888', textAlign: 'right' }}>
                  OECD Data
                </div>
                <div style={{ color: '#cccccc', textAlign: 'left' }}>
                  ‚Ä¢ Social Outcomes
                </div>
                <div style={{ color: '#888', textAlign: 'right' }}>
                  UN Stats
                </div>
                <div style={{ color: '#cccccc', textAlign: 'left' }}>
                  ‚Ä¢ Environmental
                </div>
                <div style={{ color: '#888', textAlign: 'right' }}>
                  EPA Reports
                </div>
              </div>
            </div>
            
            <div style={{
              marginTop: '1.5rem',
              padding: '0.75rem',
              background: 'rgba(255, 193, 7, 0.1)',
              border: '1px solid rgba(255, 193, 7, 0.3)',
              borderRadius: '6px',
              fontSize: '0.8rem',
              color: '#ffc107',
              width: '100%'
            }}>
              <strong>Development Priority:</strong> After Column 2 (Congress.gov)
            </div>
          </div>
        </Column>
      </ColumnContainer>
      
      {/* Overall Status Footer */}
      <div style={{
        marginTop: '2rem',
        padding: '1rem',
        background: 'rgba(0, 0, 0, 0.2)',
        borderRadius: '8px',
        border: '1px solid rgba(0, 229, 255, 0.2)',
        fontSize: '0.85rem',
        color: '#cccccc',
        textAlign: 'center'
      }}>
        <div style={{ display: 'inline-flex', alignItems: 'center', gap: '0.5rem' }}>
          <div style={{
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: '#4caf50',
            animation: 'pulse 2s infinite'
          }} />
          <span><strong>Column 1:</strong> Operational with {contributions.length} records</span>
          <span style={{ margin: '0 0.5rem' }}>‚Ä¢</span>
          <div style={{
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: '#ff9800',
            animation: 'pulse 2s infinite'
          }} />
          <span><strong>Column 2:</strong> Development in progress</span>
          <span style={{ margin: '0 0.5rem' }}>‚Ä¢</span>
          <div style={{
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: '#ff9800',
            animation: 'pulse 2s infinite'
          }} />
          <span><strong>Column 3:</strong> Planned</span>
        </div>
      </div>
    </Container>
  );
};

export default TriangulationPreview;